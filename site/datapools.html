<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at Apr 16, 2013
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20130416" />
    <meta http-equiv="Content-Language" content="en" />
    <title>GrinderScript.Net - </title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>GrinderScript.Net</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 16 Apr 2013</li>
                      
                
                    
                 <li id="projectVersion" class="pull-right">Version: 1.0</li>
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Documentation</li>
                                
      <li>
    
                          <a href="index.html" title="Introduction">
          <i class="none"></i>
        Introduction</a>
            </li>
                  
      <li>
    
                          <a href="installation.html" title="Installation">
          <i class="none"></i>
        Installation</a>
            </li>
                  
      <li>
    
                          <a href="loadtests.html" title="Writing load tests">
          <i class="none"></i>
        Writing load tests</a>
            </li>
                  
      <li class="active">
    
            <a href="#"><i class="none"></i>Using data pools</a>
          </li>
                  
      <li>
    
                          <a href="scenarios.html" title="Composing test scenarios">
          <i class="none"></i>
        Composing test scenarios</a>
            </li>
                  
      <li>
    
                          <a href="properties.html" title="grinder.properties">
          <i class="none"></i>
        grinder.properties</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                    
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Using data pools in GriderScript.Net</h1><p>It is important that you vary the test data in your load tests, to make sure you put a realistic load on all the components in your system. GrinderScript.Net contains a lightweight data pool framework that makes it easy to supply different values to the tests during load testing.</p><p>It's a good idea to write and run your first load test before you start digging into using data pools, so you have your foundation ready. Our NuGet samples package contains a few ready to use data pool examples. You should install the package into your load test project before you proceed, so you have some living code to play with while you read this. You install the sample package the normal NuGet way, from the <i>Visual Studio NuGet Package Manager</i>:</p><p><tt>install-package GrinderScript.Net.Samples</tt></p><div class="section"><h2>The four steps to create and use a data pool<a name="The_four_steps_to_create_and_use_a_data_pool"></a></h2><p>You follow these four steps when using a data pool with GrinderScript.Net:</p>
<ol style="list-style-type: decimal">
  <li>Create the class/type representing the data pool values</li>
  <li>Create the list of data pool values</li>
  <li>Load the data pool values into the load run process</li>
  <li>Fetch the data pool values and use them to vary test data in your load test worker</li>
</ol><p>We'll use an imaginary load test of a log on service as an example wen we go through these four steps. </p></div><div class="section"><h2>Creating the data pool value type<a name="Creating_the_data_pool_value_type"></a></h2><p>At the core a data pool is just a list of values. With GrinderScript.Net you can use any .Net type as the value in the list. We start by modeling the user name and password we'll provide to the tests in a <i>Credentials</i> class.</p>
<div class="source"><pre class="prettyprint">public class Credentials
{
    public string Username { get; set; }
    public string Password { get; set; }
}
</pre></div></div><div class="section"><h2>Creating the list of data pool values<a name="Creating_the_list_of_data_pool_values"></a></h2><p>GrinderScript.Net has integrated support for reading data pool values from csv (comma separated values) files. Csv is a simple, yet quite powerful format for capturing lists of data. You can easily create the content with a SQL query, as a spreadsheet or in a plain text editor. </p><p>If you want to use other data formats like Json og Xml, or read the values from other sources than the file system, e.g. from a SQL database or from some kind of web service, you'll need to implement the <tt>GrinderScript.Net.Core.IDatapoolValuesFactory&lt;T&gt;</tt> interface. How to implement your own <i>IDatapoolValuesFactory</i> is described further down, but let's look at using csv files first.</p></div><div class="section"><h2>Using cvs files<a name="Using_cvs_files"></a></h2><p>You need the GrinderScript.Net.Cvs NuGet package installed to load data pool values from csv files. You install this package into your project from the <i>Visual Studio NuGet Package Manager</i> with the command</p><p><tt>install-package GrinderScript.Net.Csv</tt></p><p>Internally we use the excellent open source framework <a class="externalLink" href="https://github.com/JoshClose/CsvHelper" title="CsvHelper GitHub repository">CsvHelper</a> to do the actual loading of the data pool values from the csv files, with the following configuration.</p>
<div class="source"><pre class="prettyprint">new CsvConfiguration { AllowComments = true, Delimiter = &quot;;&quot;, IsCaseSensitive = false, HasHeaderRecord = true};
</pre></div><p>The exact meaning of the <i>CsvConfiguration</i> class and it's properties is described in the CsvHelper documentation. Here is an example of a <i>Credentials.cvs</i> file for our <i>Credentials</i> data pool. You should check the CsvHelper documentation if the structure and content in the example don't make sense.</p>
<div class="source"><pre class="prettyprint">#Used by the imaginary log on load test Credentials data pool example
Username;Password
scott;tiger
someuser;somesecretpwd
someotheruser;someothersecretpwd
</pre></div></div><div class="section"><h2>Implementing a custom <i>IDatapoolValuesFactory</i><a name="Implementing_a_custom_IDatapoolValuesFactory"></a></h2><p>You must implement a custom <i>IDatapoolValuesFactory</i> if csv files don't suite your data pool format and/or storage needs. It's a very simple interface, with only one method.</p>
<div class="source"><pre class="prettyprint">public interface IDatapoolValuesFactory&lt;T&gt; where T : class
{
    IList&lt;T&gt; CreateValues(IGrinderContext grinderContext, string name);
}
</pre></div><p>GrinderScript.Net will call the <i>IDatapoolValuesFactory.CreateValues()</i> method once when initializing the data pool. You return the values in an <i>IList&lt;T&gt;</i> and can use the passed in <i>grinderContext</i> and <i>name</i> to read additional configuration from the <tt>grinder.properties</tt> as needed. </p><p>The next section gives more information about how and when GrinderScript.Net will call your <i>IDatapoolValuesFactory</i>, but first, here is the implementation of the <i>CreateValues()</i> method in <i>CsvDatapoolValuesFactory&lt;T&gt;</i>, as an example. </p>
<div class="source"><pre class="prettyprint">public IList&lt;T&gt; CreateValues(IGrinderContext grinderContext, string name)
{
    string fileName = grinderContext.GetProperty(DatapoolFactory.GetPropertyKey(name, &quot;csvFile&quot;), string.Format(&quot;{0}.csv&quot;, name));
    var configuration = new CsvConfiguration { AllowComments = true, Delimiter = &quot;;&quot;, IsCaseSensitive = false, HasHeaderRecord = true};
    using (var csv = new CsvReader(new StreamReader(fileName), configuration))
    {
        return csv.GetRecords&lt;T&gt;().ToList();
    }
}
</pre></div></div><div class="section"><h2>Loading the data pool values into the load run process<a name="Loading_the_data_pool_values_into_the_load_run_process"></a></h2><p>When you have your data pool values ready, either as a cvs file or in a format and storage readable by your home grown <i>IDatapoolValuesFactory</i>, you're one step away from start using it in your load test. You just need to load the values into the load run process first. You can choose from tree strategies for loading data pool values</p>
<ol style="list-style-type: decimal">
  <li>You can use the <tt>grinder.properties</tt> to configure your data pools and let GrinderScript.Net load them automatically after the script engine is initialized.</li>
  <li>You can create your own script engine and initialize the data pools in code.</li>
  <li>You can mix 1) and 2), where you first create some of your data pools from code in your own script engine and then let GrinderScript.Net load the rest from configuration in <tt>grinder.properties</tt>.</li>
</ol></div><div class="section"><h2>Loading data pool values from configuration in <i>grinder.properties</i><a name="Loading_data_pool_values_from_configuration_in_grinder.properties"></a></h2><p>The <a href="./properties.html#DataPoolConfiguration" title="Properties related to data pool configuration section in the GrinderScript.Net properties page">data pool configuration section</a> at the GrinderScript.Net properties page describes the properties you use when you configure your data pools in the <tt>grinder.properties</tt>. Here is an example of how our <i>Credentials</i> data pool could be configured:</p>
<div class="source"><pre class="prettyprint">grinderscript-dotnet.datapoolFactory.1=Credentials
grinderscript-dotnet.datapool.Credentials.valueType=GrinderScript.Net.Verifier.Datapool.Credentials, GrinderScript.Net.Verifier
grinderscript-dotnet.datapool.Credentials.factoryType=GrinderScript.Net.Core.CsvDatapoolValuesFactory`1, GrinderScript.Net.Core
grinderscript-dotnet.datapool.Credentials.random=true
grinderscript-dotnet.datapool.Credentials.seed=428653
grinderscript-dotnet.datapool.Credentials.distributionMode=ThreadShared
grinderscript-dotnet.datapool.Credentials.circular=true
grinderscript-dotnet.datapool.Credentials.csvFile=Samples\\GrinderScript.Net\\Datapool\\Credentials.csv
</pre></div><p>You probably need to adjust the <tt>valueType</tt> and <tt>csvFile</tt> with your actual namespace and file location before you can run the example with your own code.</p></div><div class="section"><h2>Loading data pool values from code in your own script engine<a name="Loading_data_pool_values_from_code_in_your_own_script_engine"></a></h2><p>GrinderScript.Net uses the <tt>GrinderScript.Net.Core.IDatapoolValuesFactory&lt;T&gt;</tt>abstraction to load data pool values. Below are some examples of how the <i>Credentials</i> data pool values can be loaded from code. All these examples extends GrinderScript.Net's <i>DefaultScriptEngine</i>. You can check out <a href="./loadtests.html#ScriptEngine" title="Writing your own script engine with GrinderScript.Net page">how to write your own script engine</a> first, if needed.</p><p>In the first example we just initializes our <i>Credentials</i> data pool from configuration in the <tt>grinder.properties</tt>. You should do this with all mandatory data pools, to make sure they always are loaded, even if nothing is configured in <tt>grinder.properties</tt>.</p>
<div class="source"><pre class="prettyprint">protected override void OnInitialize()
{
    DatapoolFactory.CreateDatapool&lt;Credentials&gt;();
}
</pre></div><p>In the next example we hard code the <i>IDatapoolValuesFactory</i> to use when initializing our <i>Credentials</i> data pool.</p>
<div class="source"><pre class="prettyprint">protected override void OnInitialize()
{
    DatapoolFactory.CreateDatapool(new CsvDatapoolValuesFactory&lt;Credentials&gt;());
}
</pre></div><p>In the last example we initialize our <i>Credentials</i> data pool by hard coding all the meta data. No configuration will be read from <tt>grinder.properties</tt> in this example.</p>
<div class="source"><pre class="prettyprint">protected override void OnInitialize()
{
    var values = new CsvDatapoolValuesFactory&lt;Credentials&gt;().CreateValues(GrinderContext);
    const bool IsRandom = true;
    var seed = (int)DateTime.Now.Ticks;
    const DatapoolThreadDistributionMode DistributionMode = DatapoolThreadDistributionMode.ThreadShared;
    const bool IsCircular = true;
    var metaData = new DefaultDatapoolMetadata&lt;Credentials&gt;(values, IsRandom, seed, DistributionMode, IsCircular);
    DatapoolFactory.CreateDatapool(metaData);
}
</pre></div><p>Mixing configuration driven and code driven loading of data pool values is as simple as following the description of both above. GrinderScript.Net will load all data pools configured in <tt>grinder.properties</tt> after your script engine is initialized. If your script engine already has configured a data pool in code it will be skipped by GrinderScript.Net's loading from <tt>grinder.properties</tt>. In this way you can freeze some data pools and let the others be configurable.</p></div><div class="section"><h2>Fetching data pool values in your load test worker<a name="Fetching_data_pool_values_in_your_load_test_worker"></a></h2><p>Having the data pool loaded into the load test process by a data pool factory, we can now use the values in our load tests. We'll use the <tt>GrinderScript.Net.Core.IDatapool&lt;T\&gt;</tt> interface for fetching values. </p>
<div class="source"><pre class="prettyprint">public interface IDatapool&lt;T&gt; where T : class
{
    T NextValue();
}
</pre></div><p>GrinderScript.Net provides an <tt>GrinderScript.Net.Core.IDatapoolManager</tt> interface that you use to gain access to the <i>IDatapool</i> instances you've created. </p>
<div class="source"><pre class="prettyprint">public interface IDatapoolManager
{
    IDatapool&lt;T&gt; GetDatapool&lt;T&gt;() where T : class;
    IDatapool&lt;T&gt; GetDatapool&lt;T&gt;(string name) where T : class;
}
</pre></div><p>If you are extending the <i>DefaultWorker</i>, you have a <i>DatapoolManager</i> member variable ready for your use. Otherwise you need to tell GrinderScript.Net that you need access to the <i>IDatapoolManager</i>, by implementing the <tt>GrinderScript.Net.Core.IDatapoolManagerAware</tt> interface in your worker. As you can see from the two <i>GetDatapool()</i> signatures, you can either pass in the type of the data pool values, or pass in both a type and a logical data pool name when you retrieve the <i>IDatapool</i>. The last one is useful if you have several data pools of the same type, and need to pick another than the default (the one with the same name as the data pool type).</p><p>You have tree options when it comes to where and how often you fetch values from the data pool</p>
<ol style="list-style-type: decimal">
  <li>You can fetch the value once and reuse it for the whole load test.</li>
  <li>You can fetch a new value for each call to <i>Run()</i>, and reuse it in all the tests call inside <i>Run()</i>.</li>
  <li>You can fetch a new value for each test call, without any reuse of the value.</li>
</ol><p>Your use case will dictate witch of the options you'll use. Below are tree code examples, one for each strategy.</p><p>Example of a worker that fetches the data pool value once during initialize, and reuse that value for the whole load test:</p>
<div class="source"><pre class="prettyprint">public class WorkerThatFetchDatapoolValueOnce : DefaultWorker
{
    private Credentials credentials;

    protected override void DefaultInitialize()
    {
        credentials = DatapoolManager.GetDatapool&lt;Credentials&gt;().NextValue();
        AddTest(1001, &quot;LogOn&quot;, TestLogOn);
    }

    private void TestLogOn()
    {
        Logger.Info(m =&gt; m(&quot;TestLogOn: Credentials.Username = '{1}', Credentials.Password = '{2}'&quot;, credentials.Username, credentials.Password));
    }
}
</pre></div><p>Example of a worker that fetches a new value for each call to <i>Run()</i>, and reuse it in all the test calls inside <i>Run()</i>.</p>
<div class="source"><pre class="prettyprint">public class WorkerThatFetchDatapoolValueBeforeEachRun : DefaultWorker
{
    private IDatapool&lt;Credentials&gt; credentialsDatapool;
    private Credentials credentials;

    protected override void DefaultInitialize()
    {
        credentialsDatapool = DatapoolManager.GetDatapool&lt;Credentials&gt;();
        AddTest(1001, &quot;LogOn&quot;, TestLogOn);
    }

    protected override void DefaultBeforeRun()
    {
        credentials = credentialsDatapool.NextValue();
    }

    private void TestLogOn()
    {
        Logger.Info(m =&gt; m(&quot;TestLogOn: Credentials.Username = '{1}', Credentials.Password = '{2}'&quot;, credentials.Username, credentials.Password));
    }
}
</pre></div><p>Example of a worker that fetches a new value for each test call, without any reuse of the value</p>
<div class="source"><pre class="prettyprint">public class WorkerThatFetchDatapoolValueBeforeEachTest : DefaultWorker
{
    private IDatapool&lt;Credentials&gt; credentialsDatapool;
    private Credentials credentials;

    protected override void DefaultInitialize()
    {
        credentialsDatapool = DatapoolManager.GetDatapool&lt;Credentials&gt;();
        AddTest(1001, &quot;LogOn&quot;, TestLogOn, () =&gt; credentials = credentialsDatapool.NextValue());
    }

    private void TestLogOn()
    {
        Logger.Info(m =&gt; m(&quot;TestLogOn: Credentials.Username = '{1}', Credentials.Password = '{2}'&quot;, credentials.Username, credentials.Password));
    }
}
</pre></div></div><div class="section"><h2>What's next<a name="Whats_next"></a></h2><p>When you're able to vary the test data in your load tests with data pools, you might want to dig into <a href="./scenarios.html" title="Composing test scenarios with GrinderScript.Net page">how to compose test scenarios</a> with GrinderScript.Net. </p><p>You can also check out the <a href="./properties.html" title="Complete list of properties used by GrinderScript.Net page">complete list of properties</a> used by GrinderScript.Net or revisit the basics about <a href="./loadtests.html" title="Writing load tests with GrinderScript.Net page">how to write load tests</a>.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                   2013.
          All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
